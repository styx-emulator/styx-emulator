/* ###
 * IP: GHIDRA
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*****************************************************************************************
 *
 * Reads the Ghidra/application.properties file and sets properties for the version,
 *  		release name, and distro prefix (ghidra_<version>)
 *
 *****************************************************************************************/


// TODO: move this to the root
def ghidraInstallDir

if (System.env.GHIDRA_INSTALL_DIR) {
    ghidraInstallDir = System.env.GHIDRA_INSTALL_DIR
}
else if (project.hasProperty("GHIDRA_INSTALL_DIR")) {
    ghidraInstallDir = project.getProperty("GHIDRA_INSTALL_DIR")
}
// TODO: or else what?
def ghidraDir = file(ghidraInstallDir + "/Ghidra").getCanonicalFile().getAbsolutePath()
def ghidraProps = new Properties()
file(ghidraDir + "/application.properties").withReader { reader ->
	ghidraProps.load(reader)
	version = ghidraProps.getProperty('application.version')
	project.ext.RELEASE_VERSION = version
	project.ext.RELEASE_NAME = ghidraProps.getProperty('application.release.name')
	project.ext.JAVA_COMPILER = ghidraProps.getProperty('application.java.compiler')
	project.ext.GRADLE_MINIMUM_VERSION = ghidraProps.getProperty('application.gradle.min')
	project.ext.DISTRO_PREFIX = "ghidra_${version}_${RELEASE_NAME}"

	def tokens = version.tokenize('.')
	project.ext.REL_MAJOR = 0;
	project.ext.REL_MINOR = 0;
	project.ext.REL_PATCH = 0;
	if (tokens.size() >= 1) {
		project.ext.REL_MAJOR = Integer.valueOf(tokens[0])
	}
	if (tokens.size() >= 2) {
		project.ext.REL_MINOR = Integer.valueOf(tokens[1])
	}
	if (tokens.size() >= 3) {
		project.ext.REL_PATCH = Integer.valueOf(tokens[2])
	}

	if (project.ext.REL_MAJOR >= 11 && project.ext.REL_MINOR >= 1) {
		project.ext.COMPATABILITY = 'src/main/v11.1.0'
	} else {
		project.ext.COMPATABILITY = 'src/main/v10.0.0'
	}


	// From the 10.3.1 release:
	project.ext.ghidra_version = ghidraProps.getProperty('application.version')
	project.ext.RELEASE_NAME = ghidraProps.getProperty('application.release.name')
	project.ext.DISTRO_PREFIX = "ghidra_${ghidra_version}"
	project.ext.GRADLE_MIN = ghidraProps.getProperty('application.gradle.min')
	project.ext.GRADLE_MAX = ghidraProps.getProperty('application.gradle.max')

	// Build dates may or may not be already present in the application.properties file.
	// If they are not present, we will set the dates so Gradle can use them, and we will
	// indicate that the build dates need to be injected into the build's final
	// application.properties file when it is copied.
	project.ext.BUILD_DATE = ghidraProps.getProperty('application.build.date')
	project.ext.BUILD_DATE_SHORT = ghidraProps.getProperty('application.build.date.short')
	project.ext.BUILD_DATES_NEEDED = false
	if (BUILD_DATE == null) {
		project.ext.BUILD_DATE = getCurrentDateTimeLong()
		project.ext.BUILD_DATE_SHORT = getCurrentDate()
		project.ext.BUILD_DATES_NEEDED = true
	}

	// If the properties contain an entry for the git revision, then it
	// must have been set by the extractor, so don't change it. If not, we will
	// need to set it in the assembleDistribution task
	project.ext.GIT_REV = ghidraProps.getProperty('application.revision.ghidra')
	project.ext.GIT_REVS_NEEDED = false;
	if (GIT_REV == null) {
        project.ext.GIT_REVS_NEEDED = true
    }
}
